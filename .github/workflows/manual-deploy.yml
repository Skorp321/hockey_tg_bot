name: Manual Deploy & Rollback

on:
  workflow_dispatch:
    inputs:
      action:
        description: '–î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
        required: true
        type: choice
        options:
          - deploy
          - rollback
          - restart
          - logs
      commit_hash:
        description: '–•—ç—à –∫–æ–º–º–∏—Ç–∞ –¥–ª—è rollback (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)'
        required: false
        type: string

jobs:
  manual-action:
    name: Execute Manual Action
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        if: inputs.action == 'deploy'
      
      - name: Deploy to Production
        if: inputs.action == 'deploy'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            echo "üîÑ Deploying to production..."
            git pull origin main
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            docker image prune -f
            echo "‚úÖ Deploy completed!"
            docker-compose ps
      
      - name: Rollback to Previous Version
        if: inputs.action == 'rollback'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            echo "‚è™ Rolling back..."
            
            # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–º–º–∏—Ç
            if [ -n "${{ inputs.commit_hash }}" ]; then
              echo "Rolling back to commit: ${{ inputs.commit_hash }}"
              git reset --hard ${{ inputs.commit_hash }}
            else
              # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
              echo "Rolling back to previous commit"
              git reset --hard HEAD~1
            fi
            
            git log --oneline -5
            
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            docker image prune -f
            echo "‚úÖ Rollback completed!"
            docker-compose ps
      
      - name: Restart Containers
        if: inputs.action == 'restart'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            echo "üîÑ Restarting containers..."
            docker-compose restart
            echo "‚úÖ Restart completed!"
            docker-compose ps
      
      - name: Show Logs
        if: inputs.action == 'logs'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            echo "üìã Container status:"
            docker-compose ps
            echo ""
            echo "üìä Last 100 log lines:"
            docker-compose logs --tail=100
