{% extends "base.html" %}

{% block content %}
<h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>

<div class="mb-4 d-flex justify-content-end">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTrainingModal">
        –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
    </button>
</div>

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<ul class="nav nav-tabs" id="trainingTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab" aria-controls="upcoming" aria-selected="true">
            üìÖ –ë—É–¥—É—â–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button" role="tab" aria-controls="past" aria-selected="false">
            üìã –ü—Ä–æ—à–µ–¥—à–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        </button>
    </li>
</ul>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
<div class="tab-content" id="trainingTabsContent">
    <!-- –í–∫–ª–∞–¥–∫–∞ –±—É–¥—É—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <div class="tab-pane fade show active" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="text-start">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                        <th class="text-center">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                        <th class="text-center">–°—Ç–∞—Ç—É—Å</th>
                        <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="upcoming-trainings">
                    {% for training in upcoming_trainings %}
                    <tr>
                        <td class="text-start">{{ training.date_time.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td class="text-center">{{ training.registrations|length }}/{{ training.max_participants }}</td>
                        <td class="text-center">
                            {% set paid_count = training.registrations|selectattr('paid')|list|length %}
                            {% set total_count = training.registrations|length %}
                            {% if total_count > 0 and paid_count == total_count %}
                                <span class="badge bg-success">‚úÖ –í—Å–µ –æ–ø–ª–∞—Ç–∏–ª–∏</span>
                            {% elif total_count > 0 %}
                                <span class="badge bg-warning">‚è≥ –ï—Å—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</span>
                            {% else %}
                                <span class="badge bg-secondary">üìù –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-success" onclick="showQuickAddModal({{ training.id }})" title="–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ">
                                    ‚ûï
                                </button>
                                <button class="btn btn-sm btn-info" onclick="toggleParticipants({{ training.id }})" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
                                    üë•
                                </button>
                                <button class="btn btn-sm btn-warning" id="rename-btn-{{ training.id }}" 
                                        onclick="showRenameModal({{ training.id }})" disabled title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTraining({{ training.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
            <!-- –°–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <tr id="participants-row-{{ training.id }}" class="participants-row" style="display: table-row;">
                <td colspan="4">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ {{ training.date_time.strftime('%d.%m.%Y %H:%M') }}</h6>
                            
                            <!-- –¢–∞–±–ª–∏—Ü–∞ –≤—Ä–∞—Ç–∞—Ä–µ–π -->
                            <div class="goalkeepers-table-container" id="goalkeepers-table-{{ training.id }}" style="display: none;">
                                <h6 class="text-primary mb-2">ü•Ö –í—Ä–∞—Ç–∞—Ä–∏</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-primary">
                                        <thead>
                                            <tr>
                                                <th>–í—Ä–∞—Ç–∞—Ä—å</th>
                                                <th class="text-center">–°–≤–µ—Ç–ª–∞—è</th>
                                                <th class="text-center">–¢–µ–º–Ω–∞—è</th>
                                                <th class="text-center">–û–ø–ª–∞—Ç–∏–ª</th>
                                                <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                                            </tr>
                                        </thead>
                                        <tbody id="goalkeepers-tbody-{{ training.id }}">
                                            <!-- –í—Ä–∞—Ç–∞—Ä–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∞–º–∏ -->
                            <div class="participants-table-container" id="participants-table-{{ training.id }}" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                                <th class="text-center">–°–≤–µ—Ç–ª–∞—è</th>
                                                <th class="text-center">–¢–µ–º–Ω–∞—è</th>
                                                <th class="text-center">1-–∞—è</th>
                                                <th class="text-center">2-–∞—è</th>
                                                <th class="text-center">–û–ø–ª–∞—Ç–∏–ª</th>
                                                <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                                            </tr>
                                        </thead>
                                        <tbody id="participants-tbody-{{ training.id }}">
                                            <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="participants-content-{{ training.id }}" class="participants-content">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                    </div>
                                    –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...
                                </div>
                            </div>
                            
                            <!-- –û–±—â–∞—è –∫–Ω–æ–ø–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –∫–æ–º–∞–Ω–¥—ã -->
                            <div class="text-center mt-3" id="distribute-button-container-{{ training.id }}" style="display: none;">
                                <button class="btn btn-secondary btn-lg" id="distribute-teams-{{ training.id }}" 
                                        onclick="distributeTeams({{ training.id }})" disabled>
                                    üèí –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
                                </button>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    </div>
    
    <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—à–µ–¥—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <div class="tab-pane fade" id="past" role="tabpanel" aria-labelledby="past-tab">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="text-start">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                        <th class="text-center">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                        <th class="text-center">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                        <th class="text-center">–°—Ç–∞—Ç—É—Å</th>
                        <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="past-trainings">
                    {% for training in past_trainings %}
                    <tr>
                        <td class="text-start">{{ training.date_time.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td class="text-center">{{ training.registrations|length }}/{{ training.max_participants }}</td>
                        <td class="text-center">
                            {% set paid_count = training.registrations|selectattr('paid')|list|length %}
                            <span class="badge bg-success">{{ paid_count }} –æ–ø–ª–∞—Ç–∏–ª–∏</span>
                            <span class="badge bg-warning">{{ training.registrations|length - paid_count }} –Ω–µ –æ–ø–ª–∞—Ç–∏–ª–∏</span>
                        </td>
                        <td class="text-center">
                            {% set paid_count = training.registrations|selectattr('paid')|list|length %}
                            {% set total_count = training.registrations|length %}
                            {% if total_count > 0 and paid_count == total_count %}
                                <span class="badge bg-success">‚úÖ –í—Å–µ –æ–ø–ª–∞—Ç–∏–ª–∏</span>
                            {% elif total_count > 0 %}
                                <span class="badge bg-warning">‚è≥ –ï—Å—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</span>
                            {% else %}
                                <span class="badge bg-secondary">üìù –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-info" onclick="togglePastParticipants({{ training.id }})" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
                                    üë•
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="viewPastTrainingStats({{ training.id }})" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
                                    üìä
                                </button>
                            </div>
                        </td>
                    </tr>
                    <!-- –°–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ—à–µ–¥—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
                    <tr id="past-participants-row-{{ training.id }}" class="participants-row" style="display: none;">
                        <td colspan="5">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ {{ training.date_time.strftime('%d.%m.%Y %H:%M') }}</h6>
                                    
                                    <div id="past-participants-content-{{ training.id }}" class="participants-content">
                                        <div class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                            </div>
                                            –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
<div class="modal fade" id="addTrainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTrainingForm" method="POST">
                    <div class="mb-3">
                        <label for="date_time" class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                        <input type="datetime-local" class="form-control" id="date_time" name="date_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="max_participants" class="form-label">–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                        <input type="number" class="form-control" id="max_participants" name="max_participants" value="10" min="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ -->
<div class="modal fade" id="quickAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="quickAddContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="addSelectedPlayers" onclick="addSelectedPlayers()" disabled>
                    –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
<div class="modal fade" id="renameParticipantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameParticipantForm">
                    <div class="mb-3">
                        <label for="current_name" class="form-label">–¢–µ–∫—É—â–µ–µ –∏–º—è</label>
                        <input type="text" class="form-control" id="current_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="telegram_username" class="form-label">Telegram –ª–æ–≥–∏–Ω</label>
                        <input type="text" class="form-control" id="telegram_username" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="new_name" class="form-label">–ù–æ–≤–æ–µ –∏–º—è</label>
                        <input type="text" class="form-control" id="new_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ)">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="goalkeeper_checkbox">
                            <label class="form-check-label" for="goalkeeper_checkbox">
                                –í—Ä–∞—Ç–∞—Ä—å
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–û–ö</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function deleteTraining(trainingId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) {
        fetch(`/training/${trainingId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
function toggleParticipants(trainingId) {
    const participantsRow = document.getElementById(`participants-row-${trainingId}`);
    const participantsContent = document.getElementById(`participants-content-${trainingId}`);
    const participantsTable = document.getElementById(`participants-table-${trainingId}`);
    
    if (participantsRow.style.display === 'none') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        participantsRow.style.display = 'table-row';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if (participantsContent.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤')) {
            loadParticipants(trainingId);
        }
    } else {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        participantsRow.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö
function loadParticipants(trainingId) {
    const participantsContent = document.getElementById(`participants-content-${trainingId}`);
    const participantsTable = document.getElementById(`participants-table-${trainingId}`);
    const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
    const goalkeepersTable = document.getElementById(`goalkeepers-table-${trainingId}`);
    const goalkeepersTbody = document.getElementById(`goalkeepers-tbody-${trainingId}`);
    
    fetch(`/training/${trainingId}/participants`)
        .then(response => response.json())
        .then(data => {
            if (data.participants.length > 0) {
                // –†–∞–∑–¥–µ–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞ –≤—Ä–∞—Ç–∞—Ä–µ–π –∏ –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
                const goalkeepers = data.participants.filter(p => p.goalkeeper);
                const fieldPlayers = data.participants.filter(p => !p.goalkeeper);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –≤—Ä–∞—Ç–∞—Ä–µ–π
                goalkeepersTbody.innerHTML = '';
                goalkeepers.forEach((participant, index) => {
                    createParticipantRow(participant, index, goalkeepersTbody, trainingId, true);
                });
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
                participantsTbody.innerHTML = '';
                fieldPlayers.forEach((participant, index) => {
                    createParticipantRow(participant, index, participantsTbody, trainingId, false);
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
                if (goalkeepers.length > 0) {
                    goalkeepersTable.style.display = 'block';
                } else {
                    goalkeepersTable.style.display = 'none';
                }
                
                if (fieldPlayers.length > 0) {
                    participantsTable.style.display = 'block';
                } else {
                    participantsTable.style.display = 'none';
                }
                
                participantsContent.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –∫–Ω–æ–ø–∫—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                const distributeButtonContainer = document.getElementById(`distribute-button-container-${trainingId}`);
                distributeButtonContainer.style.display = 'block';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                const distributeBtn = document.getElementById(`distribute-teams-${trainingId}`);
                if (distributeBtn) {
                    distributeBtn.addEventListener('click', function(e) {
                        console.log('Button clicked! Event:', e);
                        console.log('Button disabled:', this.disabled);
                        console.log('Button hasAttribute disabled:', this.hasAttribute('disabled'));
                        console.log('Button classList:', this.classList.toString());
                        
                        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ disabled, –Ω–µ –¥–∞–µ–º —Å–æ–±—ã—Ç–∏—é –≤—Å–ø–ª—ã–≤–∞—Ç—å
                        if (this.disabled || this.hasAttribute('disabled')) {
                            console.log('Button is disabled - preventing default');
                            e.preventDefault();
                            e.stopPropagation();
                            return false;
                        }
                    });
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                checkSelectionChanges(trainingId);
            } else {
                participantsContent.innerHTML = '<div class="alert alert-info text-center">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è –Ω–∞ —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>';
                participantsTable.style.display = 'none';
                goalkeepersTable.style.display = 'none';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                const distributeButtonContainer = document.getElementById(`distribute-button-container-${trainingId}`);
                distributeButtonContainer.style.display = 'none';
            }
        })
        .catch(error => {
            participantsContent.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö</div>';
            console.error('Error:', error);
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞
function createParticipantRow(participant, index, tbody, trainingId, isGoalkeeper) {
    const row = document.createElement('tr');
    const lightChecked = (participant.jersey_type === 'light') ? 'checked' : '';
    const darkChecked = (participant.jersey_type === 'dark') ? 'checked' : '';
    const savedJerseyType = participant.jersey_type || '';
    
    
    if (isGoalkeeper) {
        // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –≤—Ä–∞—Ç–∞—Ä—è (—Ç–æ–ª—å–∫–æ –º–∞–π–∫–∏)
        row.innerHTML = `
            <td onclick="selectParticipant(${trainingId}, this.parentElement)" style="cursor: pointer;" data-username="${participant.username || ''}" data-goalkeeper="${participant.goalkeeper || false}">
                <div>
                    <strong>${index + 1}. ${participant.name}</strong>
                    ${participant.team_assigned ? '<span class="badge bg-success ms-2">‚úì –ö–æ–º–∞–Ω–¥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞</span>' : ''}
                    <br>
                    <small class="text-muted">
                        –ó–∞–ø–∏—Å–∞–ª—Å—è: ${participant.registered_at}
                    </small>
                </div>
            </td>
            <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input" type="radio" 
                           name="jersey-type-${trainingId}-${participant.name}" 
                           id="light-${trainingId}-${index}" 
                           value="light" 
                           data-participant="${participant.name}"
                           data-participant-id="${participant.id}"
                           ${lightChecked}
                           data-saved-jersey="${savedJerseyType}"
                           onchange="checkSelectionChanges(${trainingId})">
                    <label class="form-check-label ms-2" for="light-${trainingId}-${index}">
                        <img src="/static/white_tshirt.svg" alt="–°–≤–µ—Ç–ª–∞—è –º–∞–π–∫–∞" class="jersey-icon">
                    </label>
                </div>
            </td>
            <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input" type="radio" 
                           name="jersey-type-${trainingId}-${participant.name}" 
                           id="dark-${trainingId}-${index}" 
                           value="dark" 
                           data-participant="${participant.name}"
                           data-participant-id="${participant.id}"
                           ${darkChecked}
                           data-saved-jersey="${savedJerseyType}"
                           onchange="checkSelectionChanges(${trainingId})">
                    <label class="form-check-label ms-2" for="dark-${trainingId}-${index}">
                        <img src="/static/black_tshirt.svg" alt="–¢–µ–º–Ω–∞—è –º–∞–π–∫–∞" class="jersey-icon">
                    </label>
                </div>
            </td>
            <td class="text-center">
                <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">
                    ${participant.paid ? '‚úì' : '‚úó'}
                </span>
            </td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="removeParticipant(${trainingId}, ${participant.id}, '${participant.name}')"
                        title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏">
                    ‚ùå
                </button>
            </td>
        `;
    } else {
        // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø–æ–ª–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (–º–∞–π–∫–∏ + –∫–æ–º–∞–Ω–¥—ã)
        const firstChecked = participant.team_type === 'first' ? 'checked' : '';
        const secondChecked = participant.team_type === 'second' ? 'checked' : '';
        const savedTeamType = participant.team_type || '';
        
        row.innerHTML = `
            <td onclick="selectParticipant(${trainingId}, this.parentElement)" style="cursor: pointer;" data-username="${participant.username || ''}" data-goalkeeper="${participant.goalkeeper || false}">
                <div>
                    <strong>${index + 1}. ${participant.name}</strong>
                    ${participant.team_assigned ? '<span class="badge bg-success ms-2">‚úì –ö–æ–º–∞–Ω–¥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞</span>' : ''}
                    <br>
                    <small class="text-muted">
                        –ó–∞–ø–∏—Å–∞–ª—Å—è: ${participant.registered_at}
                    </small>
                </div>
            </td>
            <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input" type="radio" 
                           name="jersey-type-${trainingId}-${participant.name}" 
                           id="light-${trainingId}-${index}" 
                           value="light" 
                           data-participant="${participant.name}"
                           data-participant-id="${participant.id}"
                           ${lightChecked}
                           data-saved-jersey="${savedJerseyType}"
                           onchange="checkSelectionChanges(${trainingId})">
                    <label class="form-check-label ms-2" for="light-${trainingId}-${index}">
                        <img src="/static/white_tshirt.svg" alt="–°–≤–µ—Ç–ª–∞—è –º–∞–π–∫–∞" class="jersey-icon">
                    </label>
                </div>
            </td>
            <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input" type="radio" 
                           name="jersey-type-${trainingId}-${participant.name}" 
                           id="dark-${trainingId}-${index}" 
                           value="dark" 
                           data-participant="${participant.name}"
                           data-participant-id="${participant.id}"
                           ${darkChecked}
                           data-saved-jersey="${savedJerseyType}"
                           onchange="checkSelectionChanges(${trainingId})">
                    <label class="form-check-label ms-2" for="dark-${trainingId}-${index}">
                        <img src="/static/black_tshirt.svg" alt="–¢–µ–º–Ω–∞—è –º–∞–π–∫–∞" class="jersey-icon">
                    </label>
                </div>
            </td>
            <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input" type="radio" 
                           name="team-type-${trainingId}-${participant.name}" 
                           id="first-${trainingId}-${index}" 
                           value="first" 
                           data-participant="${participant.name}"
                           data-participant-id="${participant.id}"
                           ${firstChecked}
                           data-saved-team="${savedTeamType}"
                           onchange="checkSelectionChanges(${trainingId})">
                    <label class="form-check-label ms-2" for="first-${trainingId}-${index}">
                        1Ô∏è‚É£
                    </label>
                </div>
            </td>
            <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input" type="radio" 
                           name="team-type-${trainingId}-${participant.name}" 
                           id="second-${trainingId}-${index}" 
                           value="second" 
                           data-participant="${participant.name}"
                           data-participant-id="${participant.id}"
                           ${secondChecked}
                           data-saved-team="${savedTeamType}"
                           onchange="checkSelectionChanges(${trainingId})">
                    <label class="form-check-label ms-2" for="second-${trainingId}-${index}">
                        2Ô∏è‚É£
                    </label>
                </div>
            </td>
            <td class="text-center">
                <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">
                    ${participant.paid ? '‚úì' : '‚úó'}
                </span>
            </td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="removeParticipant(${trainingId}, ${participant.id}, '${participant.name}')"
                        title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏">
                    ‚ùå
                </button>
            </td>
        `;
    }
    tbody.appendChild(row);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤—ã–±–æ—Ä–µ –º–∞–µ–∫ –∏ –∫–æ–º–∞–Ω–¥
function checkSelectionChanges(trainingId) {
    const distributeButton = document.getElementById(`distribute-teams-${trainingId}`);
    const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
    const goalkeepersTbody = document.getElementById(`goalkeepers-tbody-${trainingId}`);
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü
    const participantRows = participantsTbody ? participantsTbody.querySelectorAll('tr') : [];
    const goalkeeperRows = goalkeepersTbody ? goalkeepersTbody.querySelectorAll('tr') : [];
    
    console.log(`checkSelectionChanges: participants=${participantRows.length}, goalkeepers=${goalkeeperRows.length}`);
    
    let allJerseysSelected = true;
    let allTeamsSelected = true;
    let hasChanges = false;
    const participantSelections = {};
    const changedParticipants = [];
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞—Ç–∞—Ä–∏ (–Ω–µ—Ç –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤), —Ç–æ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
    const hasFieldPlayers = participantRows.length > 0;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    participantRows.forEach((row, index) => {
        const lightRadio = row.querySelector(`input[id="light-${trainingId}-${index}"]`);
        const darkRadio = row.querySelector(`input[id="dark-${trainingId}-${index}"]`);
        const firstRadio = row.querySelector(`input[id="first-${trainingId}-${index}"]`);
        const secondRadio = row.querySelector(`input[id="second-${trainingId}-${index}"]`);
        const participantName = lightRadio ? lightRadio.getAttribute('data-participant') : 'Unknown';
        
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ data
        const savedJerseyType = lightRadio ? lightRadio.getAttribute('data-saved-jersey') : '';
        const savedTeamType = firstRadio ? firstRadio.getAttribute('data-saved-team') : '';
        
        let jerseySelected = false;
        let teamSelected = false;
        let participantChanged = false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±–æ—Ä –º–∞–π–∫–∏
        if (lightRadio.checked) {
            participantSelections[participantName] = { jersey: 'light' };
            jerseySelected = true;
            if (savedJerseyType !== 'light') {
                participantChanged = true;
            }
        } else if (darkRadio.checked) {
            participantSelections[participantName] = { jersey: 'dark' };
            jerseySelected = true;
            if (savedJerseyType !== 'dark') {
                participantChanged = true;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
        if (firstRadio && secondRadio) {
            if (firstRadio.checked) {
                participantSelections[participantName].team = 'first';
                teamSelected = true;
                if (savedTeamType !== 'first') {
                    participantChanged = true;
                }
            } else if (secondRadio.checked) {
                participantSelections[participantName].team = 'second';
                teamSelected = true;
                if (savedTeamType !== 'second') {
                    participantChanged = true;
                }
            }
        }
        
        if (!jerseySelected) allJerseysSelected = false;
        if (!teamSelected) allTeamsSelected = false;
        if (participantChanged) {
            hasChanges = true;
            changedParticipants.push(participantName);
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–∞—Ç–∞—Ä–µ–π
    goalkeeperRows.forEach((row, index) => {
        const lightRadio = row.querySelector(`input[id="light-${trainingId}-${index}"]`);
        const darkRadio = row.querySelector(`input[id="dark-${trainingId}-${index}"]`);
        const participantName = lightRadio ? lightRadio.getAttribute('data-participant') : 'Unknown';
        
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ data
        const savedJerseyType = lightRadio ? lightRadio.getAttribute('data-saved-jersey') : '';
        
        let jerseySelected = false;
        let participantChanged = false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±–æ—Ä –º–∞–π–∫–∏
        if (lightRadio.checked) {
            participantSelections[participantName] = { jersey: 'light' };
            jerseySelected = true;
            if (savedJerseyType !== 'light') {
                participantChanged = true;
            }
        } else if (darkRadio.checked) {
            participantSelections[participantName] = { jersey: 'dark' };
            jerseySelected = true;
            if (savedJerseyType !== 'dark') {
                participantChanged = true;
            }
        }
        
        if (!jerseySelected) allJerseysSelected = false;
        if (participantChanged) {
            hasChanges = true;
            changedParticipants.push(participantName);
        }
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–±—â—É—é –∫–Ω–æ–ø–∫—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    // –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –µ—Å–ª–∏ –≤—Å–µ –º–∞–π–∫–∏ –≤—ã–±—Ä–∞–Ω—ã –ò (–Ω–µ—Ç –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –ò–õ–ò —É –≤—Å–µ—Ö –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤—ã–±—Ä–∞–Ω—ã –∫–æ–º–∞–Ω–¥—ã)
    const canDistribute = allJerseysSelected && (!hasFieldPlayers || allTeamsSelected);
    
    console.log(`allJerseysSelected: ${allJerseysSelected}, allTeamsSelected: ${allTeamsSelected}, hasFieldPlayers: ${hasFieldPlayers}, canDistribute: ${canDistribute}`);
    
    if (canDistribute) {
        if (distributeButton) {
            distributeButton.disabled = false;
            distributeButton.removeAttribute('disabled');  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏—Ä–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç
            distributeButton.classList.remove('btn-secondary');
            distributeButton.classList.add('btn-success');
            console.log('Button enabled - disabled attr removed');
        }
    } else {
        if (distributeButton) {
            distributeButton.disabled = true;
            distributeButton.setAttribute('disabled', 'disabled');  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç
            distributeButton.classList.remove('btn-success');
            distributeButton.classList.add('btn-secondary');
            console.log('Button disabled - disabled attr added');
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    window[`participantSelections_${trainingId}`] = participantSelections;
    window[`changedParticipants_${trainingId}`] = changedParticipants;
    window[`hasChanges_${trainingId}`] = hasChanges;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
function distributeTeams(trainingId) {
    console.log('=== distributeTeams called ===');
    console.log('trainingId:', trainingId);
    
    const distributeButton = document.getElementById(`distribute-teams-${trainingId}`);
    const participantSelections = window[`participantSelections_${trainingId}`];
    const changedParticipants = window[`changedParticipants_${trainingId}`];
    const hasChanges = window[`hasChanges_${trainingId}`];
    
    console.log('distributeButton:', distributeButton);
    console.log('participantSelections:', participantSelections);
    console.log('changedParticipants:', changedParticipants);
    console.log('hasChanges:', hasChanges);
    
    if (!participantSelections) {
        console.log('No participant selections - showing alert');
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞–π–∫–∏ –∏ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
        return;
    }
    
    console.log('Proceeding with distribution...');
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    if (distributeButton) {
        distributeButton.disabled = true;
        distributeButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...';
    }
    
    // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–π–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    console.log('Making request to /training/' + trainingId + '/save-jerseys');
    console.log('Request data:', { participant_selections: participantSelections });
    
    fetch(`/training/${trainingId}/save-jerseys`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            participant_selections: participantSelections
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ –º–∞–π–∫–∞–º–∏ –∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
            const allParticipantNames = Object.keys(participantSelections);
            if (allParticipantNames.length > 0) {
                console.log('Sending notifications to all participants:', allParticipantNames);
                return fetch(`/training/${trainingId}/notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        changed_participants: allParticipantNames
                    })
                });
            } else {
                console.log('No participants to notify');
                return Promise.resolve({ json: () => ({ success: true, message: '–ú–∞–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã' }) });
            }
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞–µ–∫');
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Notification response:', data);
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü
            const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
            const goalkeepersTbody = document.getElementById(`goalkeepers-tbody-${trainingId}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            if (participantsTbody) {
                const participantRows = participantsTbody.querySelectorAll('tr');
                participantRows.forEach((row, index) => {
                    const lightRadio = row.querySelector(`input[id="light-${trainingId}-${index}"]`);
                    const darkRadio = row.querySelector(`input[id="dark-${trainingId}-${index}"]`);
                    const firstRadio = row.querySelector(`input[id="first-${trainingId}-${index}"]`);
                    const secondRadio = row.querySelector(`input[id="second-${trainingId}-${index}"]`);
                    
                    if (lightRadio && lightRadio.checked) {
                        lightRadio.setAttribute('data-saved-jersey', 'light');
                    } else if (darkRadio && darkRadio.checked) {
                        darkRadio.setAttribute('data-saved-jersey', 'dark');
                    }
                    
                    if (firstRadio && firstRadio.checked) {
                        firstRadio.setAttribute('data-saved-team', 'first');
                    } else if (secondRadio && secondRadio.checked) {
                        secondRadio.setAttribute('data-saved-team', 'second');
                    }
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è –≤—Ä–∞—Ç–∞—Ä–µ–π
            if (goalkeepersTbody) {
                const goalkeeperRows = goalkeepersTbody.querySelectorAll('tr');
                goalkeeperRows.forEach((row, index) => {
                    const lightRadio = row.querySelector(`input[id="light-${trainingId}-${index}"]`);
                    const darkRadio = row.querySelector(`input[id="dark-${trainingId}-${index}"]`);
                    
                    if (lightRadio && lightRadio.checked) {
                        lightRadio.setAttribute('data-saved-jersey', 'light');
                    } else if (darkRadio && darkRadio.checked) {
                        darkRadio.setAttribute('data-saved-jersey', 'dark');
                    }
                });
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            window[`hasChanges_${trainingId}`] = false;
            window[`changedParticipants_${trainingId}`] = [];
            
            // –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, —Ç–∞–∫ –∫–∞–∫ –≤—Å–µ –º–∞–π–∫–∏ –∏ –∫–æ–º–∞–Ω–¥—ã –≤—ã–±—Ä–∞–Ω—ã
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã');
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (distributeButton) {
            distributeButton.disabled = false;
            distributeButton.innerHTML = 'üèí –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã';
        }
    });
}

document.getElementById('addTrainingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const modal = bootstrap.Modal.getInstance(document.getElementById('addTrainingModal'));
    
    fetch('/training', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            modal.hide(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
function showRenameModal(trainingId) {
    // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
    const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
    const goalkeepersTbody = document.getElementById(`goalkeepers-tbody-${trainingId}`);
    
    let selectedRow = null;
    
    // –ò—â–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    if (participantsTbody) {
        selectedRow = participantsTbody.querySelector('tr.selected');
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∏—â–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ –≤—Ä–∞—Ç–∞—Ä–µ–π
    if (!selectedRow && goalkeepersTbody) {
        selectedRow = goalkeepersTbody.querySelector('tr.selected');
    }
    
    if (!selectedRow) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    const participantName = selectedRow.querySelector('[data-participant]').getAttribute('data-participant');
    const participantId = selectedRow.querySelector('[data-participant-id]').getAttribute('data-participant-id');
    const participantUsername = selectedRow.querySelector('[data-username]').getAttribute('data-username');
    const participantGoalkeeper = selectedRow.querySelector('[data-goalkeeper]').getAttribute('data-goalkeeper') === 'true';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('current_name').value = participantName;
    document.getElementById('telegram_username').value = participantUsername || '–ù–µ —É–∫–∞–∑–∞–Ω';
    document.getElementById('new_name').value = '';
    document.getElementById('goalkeeper_checkbox').checked = participantGoalkeeper;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    document.getElementById('renameParticipantForm').setAttribute('data-training-id', trainingId);
    document.getElementById('renameParticipantForm').setAttribute('data-participant-id', participantId);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('renameParticipantModal'));
    modal.show();
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
function selectParticipant(trainingId, row) {
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫ –≤ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
    const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
    const goalkeepersTbody = document.getElementById(`goalkeepers-tbody-${trainingId}`);
    
    // –û—á–∏—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    if (participantsTbody) {
        const participantRows = participantsTbody.querySelectorAll('tr');
        participantRows.forEach(r => r.classList.remove('selected'));
    }
    
    // –û—á–∏—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –≤—Ä–∞—Ç–∞—Ä–µ–π
    if (goalkeepersTbody) {
        const goalkeeperRows = goalkeepersTbody.querySelectorAll('tr');
        goalkeeperRows.forEach(r => r.classList.remove('selected'));
    }
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
    row.classList.add('selected');
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
    const renameBtn = document.getElementById(`rename-btn-${trainingId}`);
    renameBtn.disabled = false;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
document.getElementById('renameParticipantForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const trainingId = this.getAttribute('data-training-id');
    const participantId = this.getAttribute('data-participant-id');
    const newNameInput = document.getElementById('new_name').value.trim();
    const currentName = document.getElementById('current_name').value;
    const isGoalkeeper = document.getElementById('goalkeeper_checkbox').checked;
    
    // –ï—Å–ª–∏ –Ω–æ–≤–æ–µ –∏–º—è –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –∏–º—è
    const newName = newNameInput || currentName;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
    fetch(`/training/${trainingId}/participant/${participantId}/rename`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: newName,
            goalkeeper: isGoalkeeper
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('renameParticipantModal'));
            modal.hide();
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            loadParticipants(trainingId);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
function showQuickAddModal(trainingId) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
    window.currentTrainingId = trainingId;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('quickAddModal'));
    modal.show();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
    loadQuickAddPlayers(trainingId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
function loadQuickAddPlayers(trainingId) {
    const content = document.getElementById('quickAddContent');
    
    fetch(`/training/${trainingId}/quick-add-players`)
        .then(response => response.json())
        .then(data => {
            console.log('Quick add players response:', data);
            if (data.success && data.players.length > 0) {
                let html = '<div class="row">';
                data.players.forEach(player => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input player-checkbox" type="checkbox" 
                                               value="${player.user_id}" id="player-${player.user_id}"
                                               data-username="${player.username || ''}"
                                               data-display-name="${player.display_name || ''}"
                                               data-goalkeeper="${player.goalkeeper || false}"
                                               onchange="updateAddButton()">
                                        <label class="form-check-label" for="player-${player.user_id}">
                                            <strong>${player.display_name || player.username || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong>
                                            ${player.goalkeeper ? ' ü•Ö' : ''}
                                            <br>
                                            <small class="text-muted">
                                                –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å: ${player.last_registration || '–ù–µ –∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è'}
                                            </small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                content.innerHTML = html;
            } else {
                let debugInfo = '';
                if (data.debug) {
                    debugInfo = `<br><small class="text-muted">
                        –û—Ç–ª–∞–¥–∫–∞: –í—Å–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π: ${data.debug.total_registrations}, 
                        –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.debug.unique_users}, 
                        –¢–µ–∫—É—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${data.debug.current_participants.length}
                    </small>`;
                }
                content.innerHTML = `<div class="alert alert-info text-center">
                    –ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è${debugInfo}
                </div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤</div>';
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö"
function updateAddButton() {
    const checkboxes = document.querySelectorAll('.player-checkbox:checked');
    const addButton = document.getElementById('addSelectedPlayers');
    
    if (checkboxes.length > 0) {
        addButton.disabled = false;
        addButton.textContent = `–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (${checkboxes.length})`;
    } else {
        addButton.disabled = true;
        addButton.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
function removeParticipant(trainingId, participantId, participantName) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${participantName} –∏–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?`)) {
        fetch(`/training/${trainingId}/participant/${participantId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                loadParticipants(trainingId);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
function addSelectedPlayers() {
    const checkboxes = document.querySelectorAll('.player-checkbox:checked');
    const trainingId = window.currentTrainingId;
    
    if (checkboxes.length === 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        return;
    }
    
    const selectedPlayers = Array.from(checkboxes).map(checkbox => ({
        user_id: parseInt(checkbox.value),
        username: checkbox.getAttribute('data-username'),
        display_name: checkbox.getAttribute('data-display-name'),
        goalkeeper: checkbox.getAttribute('data-goalkeeper') === 'true'
    }));
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    const addButton = document.getElementById('addSelectedPlayers');
    addButton.disabled = true;
    addButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
    
    fetch(`/training/${trainingId}/bulk-register`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            players: selectedPlayers
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddModal'));
            modal.hide();
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–æ–≤');
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        addButton.disabled = false;
        addButton.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö';
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ—à–µ–¥—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
function togglePastParticipants(trainingId) {
    const participantsRow = document.getElementById(`past-participants-row-${trainingId}`);
    const participantsContent = document.getElementById(`past-participants-content-${trainingId}`);
    
    if (participantsRow.style.display === 'none') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        participantsRow.style.display = 'table-row';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if (participantsContent.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤')) {
            loadPastParticipants(trainingId);
        }
    } else {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        participantsRow.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö –ø—Ä–æ—à–µ–¥—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
function loadPastParticipants(trainingId) {
    const participantsContent = document.getElementById(`past-participants-content-${trainingId}`);
    
    fetch(`/training/${trainingId}/participants`)
        .then(response => response.json())
        .then(data => {
            if (data.participants.length > 0) {
                let html = '<div class="row">';
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
                const goalkeepers = data.participants.filter(p => p.goalkeeper);
                const lightFirst = data.participants.filter(p => !p.goalkeeper && p.jersey_type === 'light' && p.team_type === 'first');
                const darkFirst = data.participants.filter(p => !p.goalkeeper && p.jersey_type === 'dark' && p.team_type === 'first');
                const lightSecond = data.participants.filter(p => !p.goalkeeper && p.jersey_type === 'light' && p.team_type === 'second');
                const darkSecond = data.participants.filter(p => !p.goalkeeper && p.jersey_type === 'dark' && p.team_type === 'second');
                const unassigned = data.participants.filter(p => !p.goalkeeper && (!p.jersey_type || !p.team_type));
                
                // –í—Ä–∞—Ç–∞—Ä–∏
                if (goalkeepers.length > 0) {
                    html += '<div class="col-md-6 mb-3"><h6>ü•Ö –í—Ä–∞—Ç–∞—Ä–∏</h6><ul class="list-group">';
                    goalkeepers.forEach(participant => {
                        const paidStatus = participant.paid ? '‚úÖ' : '‚ùå';
                        const jerseyEmoji = participant.jersey_type === 'light' ? '‚ö™' : '‚ö´';
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${participant.name} ${jerseyEmoji}
                            <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">${paidStatus}</span>
                        </li>`;
                    });
                    html += '</ul></div>';
                }
                
                // –ö–æ–º–∞–Ω–¥—ã
                if (lightFirst.length > 0) {
                    html += '<div class="col-md-6 mb-3"><h6>‚ö™ 1-–∞—è –ø—è—Ç–µ—Ä–∫–∞ (—Å–≤–µ—Ç–ª—ã–µ)</h6><ul class="list-group">';
                    lightFirst.forEach(participant => {
                        const paidStatus = participant.paid ? '‚úÖ' : '‚ùå';
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${participant.name}
                            <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">${paidStatus}</span>
                        </li>`;
                    });
                    html += '</ul></div>';
                }
                
                if (darkFirst.length > 0) {
                    html += '<div class="col-md-6 mb-3"><h6>‚ö´ 1-–∞—è –ø—è—Ç–µ—Ä–∫–∞ (—Ç–µ–º–Ω—ã–µ)</h6><ul class="list-group">';
                    darkFirst.forEach(participant => {
                        const paidStatus = participant.paid ? '‚úÖ' : '‚ùå';
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${participant.name}
                            <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">${paidStatus}</span>
                        </li>`;
                    });
                    html += '</ul></div>';
                }
                
                if (lightSecond.length > 0) {
                    html += '<div class="col-md-6 mb-3"><h6>‚ö™ 2-–∞—è –ø—è—Ç–µ—Ä–∫–∞ (—Å–≤–µ—Ç–ª—ã–µ)</h6><ul class="list-group">';
                    lightSecond.forEach(participant => {
                        const paidStatus = participant.paid ? '‚úÖ' : '‚ùå';
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${participant.name}
                            <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">${paidStatus}</span>
                        </li>`;
                    });
                    html += '</ul></div>';
                }
                
                if (darkSecond.length > 0) {
                    html += '<div class="col-md-6 mb-3"><h6>‚ö´ 2-–∞—è –ø—è—Ç–µ—Ä–∫–∞ (—Ç–µ–º–Ω—ã–µ)</h6><ul class="list-group">';
                    darkSecond.forEach(participant => {
                        const paidStatus = participant.paid ? '‚úÖ' : '‚ùå';
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${participant.name}
                            <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">${paidStatus}</span>
                        </li>`;
                    });
                    html += '</ul></div>';
                }
                
                if (unassigned.length > 0) {
                    html += '<div class="col-md-6 mb-3"><h6>‚ùì –ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ</h6><ul class="list-group">';
                    unassigned.forEach(participant => {
                        const paidStatus = participant.paid ? '‚úÖ' : '‚ùå';
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${participant.name}
                            <span class="badge ${participant.paid ? 'bg-success' : 'bg-danger'}">${paidStatus}</span>
                        </li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += '</div>';
                participantsContent.innerHTML = html;
            } else {
                participantsContent.innerHTML = '<div class="alert alert-info text-center">–ù–∞ —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è</div>';
            }
        })
        .catch(error => {
            participantsContent.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö</div>';
            console.error('Error:', error);
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—à–µ–¥—à–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
function viewPastTrainingStats(trainingId) {
    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≤ –±—É–¥—É—â–µ–º
    alert('–§—É–Ω–∫—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö');
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ ID —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –±—É–¥—É—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    const trainingRows = document.querySelectorAll('tr[id^="participants-row-"]');
    trainingRows.forEach(function(row) {
        const trainingId = row.id.replace('participants-row-', '');
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        loadParticipants(trainingId);
    });
});
</script>

<style>
.participants-row {
    background-color: #f8f9fa;
}

.participants-row .card {
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.participants-row .card-body {
    padding: 1rem;
}

.participants-table-container .table {
    margin-bottom: 0;
}

.participants-table-container .table th {
    background-color: #f8f9fa;
    border-top: none;
    font-weight: 600;
}

.participants-table-container .table td {
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü */
.table th {
    background-color: #e9ecef;
    border-top: none;
    font-weight: 600;
    padding: 12px 8px;
}

.table td {
    padding: 12px 8px;
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
    padding: 0.5em 0.75em;
}

.btn-group .btn {
    margin-right: 2px;
    padding: 0.375rem 0.5rem;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.table-responsive {
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table {
    margin-bottom: 0;
}

.table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-success:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
}

.form-check {
    margin: 0;
}

.form-check-label {
    cursor: pointer;
}

.jersey-icon {
    width: 24px;
    height: 24px;
    transition: transform 0.2s ease;
}

.form-check-input:checked + .form-check-label .jersey-icon {
    transform: scale(1.2);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ */
tr.selected {
    background-color: #e3f2fd !important;
}

tr:hover {
    background-color: #f5f5f5;
}

tr.selected:hover {
    background-color: #bbdefb !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è */
.btn-warning:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
}
</style>
{% endblock %} 