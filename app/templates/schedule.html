{% extends "base.html" %}

{% block content %}
<h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>

<div class="mb-4">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTrainingModal">
        –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
    </button>
</div>

<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for training in trainings %}
            <tr>
                <td>{{ training.date_time.strftime('%d.%m.%Y %H:%M') }}</td>
                <td>{{ training.registrations|length }}/{{ training.max_participants }}</td>
                <td>
                    <button class="btn btn-sm btn-info me-2" onclick="toggleParticipants({{ training.id }})">
                        üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTraining({{ training.id }})">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </td>
            </tr>
            <!-- –°–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <tr id="participants-row-{{ training.id }}" class="participants-row" style="display: none;">
                <td colspan="3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ {{ training.date_time.strftime('%d.%m.%Y %H:%M') }}</h6>
                            
                            <!-- –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∞–º–∏ -->
                            <div class="participants-table-container" id="participants-table-{{ training.id }}" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                                <th class="text-center">–°–≤–µ—Ç–ª–∞—è</th>
                                                <th class="text-center">–¢–µ–º–Ω–∞—è</th>
                                            </tr>
                                        </thead>
                                        <tbody id="participants-tbody-{{ training.id }}">
                                            <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –∫–æ–º–∞–Ω–¥—ã -->
                                <div class="text-center mt-3">
                                    <button class="btn btn-success btn-lg" id="distribute-teams-{{ training.id }}" 
                                            onclick="distributeTeams({{ training.id }})" disabled>
                                        üèí –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
                                    </button>
                                </div>
                            </div>
                            
                            <div id="participants-content-{{ training.id }}" class="participants-content">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                    </div>
                                    –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
<div class="modal fade" id="addTrainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTrainingForm" method="POST">
                    <div class="mb-3">
                        <label for="date_time" class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                        <input type="datetime-local" class="form-control" id="date_time" name="date_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="max_participants" class="form-label">–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                        <input type="number" class="form-control" id="max_participants" name="max_participants" value="10" min="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function deleteTraining(trainingId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) {
        fetch(`/training/${trainingId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
function toggleParticipants(trainingId) {
    const participantsRow = document.getElementById(`participants-row-${trainingId}`);
    const participantsContent = document.getElementById(`participants-content-${trainingId}`);
    const participantsTable = document.getElementById(`participants-table-${trainingId}`);
    
    if (participantsRow.style.display === 'none') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        participantsRow.style.display = 'table-row';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if (participantsContent.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤')) {
            loadParticipants(trainingId);
        }
    } else {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        participantsRow.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö
function loadParticipants(trainingId) {
    const participantsContent = document.getElementById(`participants-content-${trainingId}`);
    const participantsTable = document.getElementById(`participants-table-${trainingId}`);
    const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
    
    fetch(`/training/${trainingId}/participants`)
        .then(response => response.json())
        .then(data => {
            if (data.participants.length > 0) {
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
                participantsTbody.innerHTML = '';
                data.participants.forEach((participant, index) => {
                    const row = document.createElement('tr');
                    const lightChecked = participant.jersey_type === 'light' ? 'checked' : '';
                    const darkChecked = participant.jersey_type === 'dark' ? 'checked' : '';
                    
                    row.innerHTML = `
                        <td>
                            <div>
                                <strong>${index + 1}. ${participant.username}</strong>
                                <br>
                                <small class="text-muted">
                                    –ó–∞–ø–∏—Å–∞–ª—Å—è: ${participant.registered_at}
                                </small>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="form-check d-flex justify-content-center">
                                <input class="form-check-input" type="radio" 
                                       name="training-type-${trainingId}-${participant.username}" 
                                       id="light-${trainingId}-${index}" 
                                       value="light" 
                                       data-participant="${participant.username}"
                                       ${lightChecked}
                                       onchange="checkJerseyChanges(${trainingId})">
                                <label class="form-check-label ms-2" for="light-${trainingId}-${index}">
                                    <img src="/static/white_tshirt.svg" alt="–°–≤–µ—Ç–ª–∞—è –º–∞–π–∫–∞" class="jersey-icon">
                                </label>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="form-check d-flex justify-content-center">
                                <input class="form-check-input" type="radio" 
                                       name="training-type-${trainingId}-${participant.username}" 
                                       id="dark-${trainingId}-${index}" 
                                       value="dark" 
                                       data-participant="${participant.username}"
                                       ${darkChecked}
                                       onchange="checkJerseyChanges(${trainingId})">
                                <label class="form-check-label ms-2" for="dark-${trainingId}-${index}">
                                    <img src="/static/black_tshirt.svg" alt="–¢–µ–º–Ω–∞—è –º–∞–π–∫–∞" class="jersey-icon">
                                </label>
                            </div>
                        </td>
                    `;
                    participantsTbody.appendChild(row);
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                participantsTable.style.display = 'block';
                participantsContent.style.display = 'none';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                checkJerseyChanges(trainingId);
            } else {
                participantsContent.innerHTML = '<div class="alert alert-info text-center">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è –Ω–∞ —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>';
                participantsTable.style.display = 'none';
            }
        })
        .catch(error => {
            participantsContent.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö</div>';
            console.error('Error:', error);
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤—ã–±–æ—Ä–µ –º–∞–µ–∫
function checkJerseyChanges(trainingId) {
    const distributeButton = document.getElementById(`distribute-teams-${trainingId}`);
    const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
    const rows = participantsTbody.querySelectorAll('tr');
    
    let allSelected = true;
    let hasChanges = false;
    const participantSelections = {};
    const changedParticipants = [];
    
    rows.forEach((row, index) => {
        const lightRadio = row.querySelector(`input[id="light-${trainingId}-${index}"]`);
        const darkRadio = row.querySelector(`input[id="dark-${trainingId}-${index}"]`);
        const participantName = lightRadio.getAttribute('data-participant');
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–∏–ø –º–∞–π–∫–∏ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ data
        const savedJerseyType = lightRadio.getAttribute('data-saved-jersey');
        
        if (lightRadio.checked) {
            participantSelections[participantName] = 'light';
            if (savedJerseyType !== 'light') {
                hasChanges = true;
                changedParticipants.push(participantName);
            }
        } else if (darkRadio.checked) {
            participantSelections[participantName] = 'dark';
            if (savedJerseyType !== 'dark') {
                hasChanges = true;
                changedParticipants.push(participantName);
            }
        } else {
            allSelected = false;
        }
    });
    
    if (allSelected) {
        distributeButton.disabled = false;
        distributeButton.classList.remove('btn-secondary');
        distributeButton.classList.add('btn-success');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        window[`participantSelections_${trainingId}`] = participantSelections;
        window[`changedParticipants_${trainingId}`] = changedParticipants;
        window[`hasChanges_${trainingId}`] = hasChanges;
    } else {
        distributeButton.disabled = true;
        distributeButton.classList.remove('btn-success');
        distributeButton.classList.add('btn-secondary');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
function distributeTeams(trainingId) {
    const distributeButton = document.getElementById(`distribute-teams-${trainingId}`);
    const participantSelections = window[`participantSelections_${trainingId}`];
    const changedParticipants = window[`changedParticipants_${trainingId}`];
    const hasChanges = window[`hasChanges_${trainingId}`];
    
    if (!participantSelections) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞–π–∫–∏ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
        return;
    }
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    distributeButton.disabled = true;
    distributeButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...';
    
    // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–π–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    fetch(`/training/${trainingId}/save-jerseys`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            participant_selections: participantSelections
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if (hasChanges && changedParticipants.length > 0) {
                return fetch(`/training/${trainingId}/notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        changed_participants: changedParticipants
                    })
                });
            } else {
                return Promise.resolve({ json: () => ({ success: true, message: '–ú–∞–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã' }) });
            }
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞–µ–∫');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const participantsTbody = document.getElementById(`participants-tbody-${trainingId}`);
            const rows = participantsTbody.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                const lightRadio = row.querySelector(`input[id="light-${trainingId}-${index}"]`);
                const darkRadio = row.querySelector(`input[id="dark-${trainingId}-${index}"]`);
                const participantName = lightRadio.getAttribute('data-participant');
                
                if (lightRadio.checked) {
                    lightRadio.setAttribute('data-saved-jersey', 'light');
                } else if (darkRadio.checked) {
                    darkRadio.setAttribute('data-saved-jersey', 'dark');
                }
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            window[`hasChanges_${trainingId}`] = false;
            window[`changedParticipants_${trainingId}`] = [];
            
            // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
            distributeButton.disabled = true;
            distributeButton.classList.remove('btn-success');
            distributeButton.classList.add('btn-secondary');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã');
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        distributeButton.disabled = false;
        distributeButton.innerHTML = 'üèí –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã';
    });
}

document.getElementById('addTrainingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const modal = bootstrap.Modal.getInstance(document.getElementById('addTrainingModal'));
    
    fetch('/training', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            modal.hide(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
    });
});
</script>

<style>
.participants-row {
    background-color: #f8f9fa;
}

.participants-row .card {
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.participants-row .card-body {
    padding: 1rem;
}

.participants-table-container .table {
    margin-bottom: 0;
}

.participants-table-container .table th {
    background-color: #f8f9fa;
    border-top: none;
    font-weight: 600;
}

.participants-table-container .table td {
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-success:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
}

.form-check {
    margin: 0;
}

.form-check-label {
    cursor: pointer;
}

.jersey-icon {
    width: 24px;
    height: 24px;
    transition: transform 0.2s ease;
}

.form-check-input:checked + .form-check-label .jersey-icon {
    transform: scale(1.2);
}
</style>
{% endblock %} 